<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BEVE POWER | QR Cell Decoder (GitHub Pages)</title>
<meta name="description" content="Decode GREAT POWER cell QR codes for BEVE POWER TITAN batteries. Manual entry or camera scan when online." />
<style>
  :root{
    --brand:#d92323; --bg:#fafafa; --card:#fff; --text:#222; --muted:#666; --border:#e9e9e9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  header{background:#fff;box-shadow:0 1px 8px rgba(0,0,0,.06);padding:14px;position:sticky;top:0;z-index:10;text-align:center}
  header img{max-width:220px;width:100%;height:auto}
  header h1{margin:.4rem 0 0 0;color:var(--brand);font-size:clamp(1.1rem,2.5vw,1.6rem)}
  main{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .box{flex:1 1 220px;background:#f7f7f7;border:1px solid var(--border);border-radius:10px;padding:10px}
  label{font-weight:600;display:block;margin:.25rem 0}
  input[type=text]{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:1rem}
  input[type=text]:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(217,35,35,.12)}
  button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:1rem;cursor:pointer;margin:.3rem .25rem}
  button.secondary{background:#222}
  button:disabled{background:#aaa;cursor:not-allowed}
  .muted{color:var(--muted);font-size:.95rem}
  .status{font-size:.95rem;margin-top:.4rem}
  .ok{color:#0a7f2e} .warn{color:#b85c00} .err{color:#b00020}
  #qrScanner{min-height:220px;border:1px dashed var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  footer{color:#777;text-align:center;padding:18px 8px 36px}
  @media (max-width:600px){header img{max-width:180px} #qrScanner{min-height:180px}}
</style>
</head>
<body>
<header>
  <img src="https://i.postimg.cc/v8CLk3Nv/Screenshot-2025-09-28-104524.png" alt="BEVE POWER Logo" />
  <h1>QR Cell Decoder</h1>
</header>

<main>
  <!-- Manual + Camera card -->
  <section class="card">
    <p class="muted">Use manual entry anytime. Camera scanning is available only when online (GitHub Pages will fetch the scanner library from a CDN).</p>

    <label for="qrInput">QR payload text</label>
    <input id="qrInput" type="text" placeholder="e.g. 02KCBFD16100BGF2R2001758" autocomplete="off" />
    <div>
      <button id="decodeBtn" onclick="decodeInput()">Decode</button>
      <button class="secondary" onclick="clearAll()">Clear</button>
    </div>

    <div class="status" id="netStatus">Checking connection…</div>
    <p class="muted" style="margin:.5rem 0 .4rem">Camera scan (online only)</p>
    <div id="qrScanner">Camera will appear here when online.</div>
    <div style="margin-top:8px">
      <button id="startBtn" onclick="startScanner()" disabled>Start Camera</button>
      <button id="stopBtn" class="secondary" onclick="stopScanner()" disabled>Stop Camera</button>
    </div>
  </section>

  <!-- Results -->
  <section id="decodedCard" class="card" style="display:none">
    <h2 style="margin:.2rem 0 1rem">Decoded Information</h2>
    <div class="row">
      <div class="box"><b>Cell Type</b><div id="cellType"></div></div>
      <div class="box"><b>Capacity</b><div id="capacity"></div></div>
      <div class="box"><b>Voltage</b><div id="voltage"></div></div>
      <div class="box"><b>Production Base</b><div id="base"></div></div>
      <div class="box"><b>Production Date</b><div id="date"></div></div>
      <div class="box"><b>Serial</b><div id="serial"></div></div>
    </div>
    <p id="notes" class="muted" style="margin-top:10px"></p>
  </section>

  <!-- Help -->
  <section class="card">
    <h2 style="margin:.2rem 0 .6rem">How this works (GitHub Pages)</h2>
    <ul class="muted" style="margin:.2rem 0 .6rem">
      <li>When your browser is <b>online</b>, this page loads the camera scanner from a CDN (unpkg → jsDelivr fallback).</li>
      <li>When <b>offline</b> or if CDNs are blocked, camera is disabled. You can still paste the QR code text and decode it.</li>
    </ul>
  </section>
</main>

<footer>© <span id="yearNow"></span> BEVE POWER</footer>

<script>
/* -------------------------------
   Online-only loader for GitHub Pages
   Tries unpkg, then jsDelivr.
--------------------------------- */
const CDN_LIST = [
  "https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js",
  "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"
];
let html5Ready=false, scanner=null, running=false;

function setStatus(text, cls){
  const el=document.getElementById('netStatus');
  el.textContent=text;
  el.className='status ' + (cls||'');
}

function toggleButtons(){
  document.getElementById('startBtn').disabled = !html5Ready || !navigator.onLine;
  document.getElementById('stopBtn').disabled = !running;
}

function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src; s.async=true;
    s.onload=()=>res(src);
    s.onerror=()=>rej(new Error('Failed to load '+src));
    document.head.appendChild(s);
  });
}

async function tryLoadFromCDNs(){
  for(const url of CDN_LIST){
    try{
      await loadScript(url);
      if(typeof Html5Qrcode==='function'){
        html5Ready=true;
        setStatus('Online: camera scanning available.', 'ok');
        toggleButtons();
        return true;
      }
    }catch(e){ /* try next */ }
  }
  setStatus('Could not load camera library from CDN. Camera disabled. You can still paste QR text.', 'warn');
  toggleButtons();
  return false;
}

function updateOnlineState(){
  if(navigator.onLine){
    setStatus('Online: loading camera support…', 'ok');
    tryLoadFromCDNs();
  }else{
    setStatus('Offline: camera scanning disabled. Manual entry works.', 'warn');
    html5Ready=false; running=false;
    toggleButtons();
  }
}

window.addEventListener('online', updateOnlineState);
window.addEventListener('offline', updateOnlineState);
window.addEventListener('load', ()=>{
  document.getElementById('yearNow').textContent = new Date().getFullYear();
  updateOnlineState();
  // Optional: prefill an example for a quick test
  document.getElementById('qrInput').value = '02KCBFD16100BGF2R2001758';
});

/* -------------------------------
   Decoder logic (from your spec)
--------------------------------- */
const yearMap={'B':2021,'C':2022,'D':2023,'E':2024,'F':2025,'G':2026,'H':2027,'J':2028,'K':2029};
const monthMap={'1':'Jan','2':'Feb','3':'Mar','4':'Apr','5':'May','6':'Jun','7':'Jul','8':'Aug','9':'Sep','A':'Oct','B':'Nov','C':'Dec'};
const dateMap={'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'A':10,'B':11,'C':12,'D':13,'E':14,'F':15,'G':16,'H':17,'J':18,'K':19,'L':20,'M':21,'N':22,'P':23,'R':24,'S':25,'T':26,'V':27,'W':28,'X':29,'Y':30,'O':31};

function decodeCell(qr){
  qr = (qr||'').trim().toUpperCase();
  if(!qr) return {error:'Empty QR payload'};
  const serialMatch = qr.match(/\d{5,}$/);
  const serial = serialMatch ? serialMatch[0] : 'Unknown';
  const before = serialMatch ? qr.slice(0,-serial.length) : qr;
  const dateC = before.slice(-1), monthC = before.slice(-2,-1), yearC = before.slice(-3,-2);
  const year = yearMap[yearC] || 'Unknown', month = monthMap[monthC] || 'Unknown', day = dateMap[dateC] || 'Unknown';
  const capacity = qr.includes('300') ? '300Ah' : qr.includes('280') ? '280Ah' : qr.includes('100') ? '100Ah' : 'Unknown';
  return {year,month,day,serial,capacity};
}

function decodeInput(){
  const txt = document.getElementById('qrInput').value;
  const r = decodeCell(txt);
  if(r.error){ alert(r.error); return; }
  document.getElementById('decodedCard').style.display='block';
  document.getElementById('cellType').textContent = 'GREAT POWER';
  document.getElementById('capacity').textContent = r.capacity;
  document.getElementById('voltage').textContent = '3.2V';
  document.getElementById('base').textContent = 'BEVE Factory';
  document.getElementById('date').textContent = `${r.day} ${r.month} ${r.year}`;
  document.getElementById('serial').textContent = r.serial;
  document.getElementById('notes').textContent = 'Decoded successfully.';
}

function clearAll(){
  document.getElementById('qrInput').value='';
  document.getElementById('decodedCard').style.display='none';
  stopScanner();
}

/* -------------------------------
   Camera control (online only)
--------------------------------- */
async function startScanner(){
  if(!navigator.onLine){ alert('You are offline. Camera scanning is available only when online.'); return; }
  if(typeof Html5Qrcode!=='function'){ alert('Camera library not loaded yet. Please wait or refresh.'); return; }
  try{
    scanner = new Html5Qrcode('qrScanner');
    const cfg = { fps: 10, qrbox: { width: 250, height: 250 } };
    await scanner.start({ facingMode:'environment' }, cfg, (text)=>{
      stopScanner();
      document.getElementById('qrInput').value = text;
      decodeInput();
    });
    running = true;
    toggleButtons();
  }catch(e){
    alert('Camera error: ' + e);
    running = false;
    toggleButtons();
  }
}

function stopScanner(){
  if(scanner && running){
    scanner.stop().then(()=>scanner.clear()).catch(()=>{});
  }
  running = false;
  toggleButtons();
}
</script>
</body>
</html>
