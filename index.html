<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BEVE POWER | QR Cell Decoder</title>
  <meta name="description" content="Decode GREAT POWER cell QR codes for BEVE POWER TITAN batteries." />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="site.webmanifest" />
  <style>
    :root{
      --brand:#d92323;
      --card:#ffffff;
      --bg:#fafafa;
      --text:#222;
      --muted:#555;
      --border:#e9e9e9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    header{
      background:#fff; box-shadow:0 1px 6px rgba(0,0,0,.06);
      display:flex; align-items:center; justify-content:center; flex-direction:column; padding:16px;
      position:sticky; top:0; z-index:10;
    }
    header img{ max-width:220px; height:auto; width:100%; }
    header h1{ color:var(--brand); font-size:clamp(1.1rem, 2.5vw, 1.6rem); margin:.5rem 0 0 0;}
    main{ max-width:960px; margin:0 auto; padding:16px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin:12px 0;
      box-shadow:0 2px 10px rgba(0,0,0,.03);
    }
    label{ display:block; font-weight:600; margin-bottom:6px; }
    input[type=text]{
      width:100%; padding:12px; font-size:1rem; border:1px solid var(--border); border-radius:10px; outline:none;
    }
    input[type=text]:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(217,35,35,.12); }
    .btn{
      background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 14px; font-size:1rem; cursor:pointer;
      margin:.3rem .25rem .3rem 0;
    }
    .btn.secondary{ background:#222; }
    .btn:disabled{ background:#999; cursor:not-allowed; }
    #qrScanner{ min-height:220px; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:12px; border:1px dashed var(--border); }
    .muted{ color:var(--muted); font-size:.95rem; }
    h2{ margin:.2rem 0 1rem; font-size:clamp(1rem,2.2vw,1.25rem); }
    .result{ display:flex; flex-wrap:wrap; gap:10px; }
    .box{ flex:1 1 220px; background:#f8f8f8; border:1px solid var(--border); border-radius:10px; padding:10px; }
    .box b{ display:block; font-size:.9rem; color:#333; margin-bottom:4px; }
    footer{ text-align:center; color:#777; font-size:.9rem; padding:18px 8px 36px; }
    @media (max-width:600px){
      header img{ max-width:180px; }
      #qrScanner{ min-height:180px; }
    }
  </style>
</head>
<body>
  <header>
    <!-- Using your hosted logo; replace with a local file if desired -->
    <img src="https://i.postimg.cc/v8CLk3Nv/Screenshot-2025-09-28-104524.png" alt="BEVE POWER Logo" />
    <h1>QR Cell Decoder</h1>
  </header>

  <main>
    <section class="card">
      <p class="muted">Supports phones and PCs. Paste the QR payload text or scan with your camera.</p>
      <label for="qrInput">QR payload</label>
      <input id="qrInput" type="text" placeholder="e.g. 02KCBFD16100BGF2R2001758" autocomplete="off" />
      <div style="margin-top:8px">
        <button class="btn" onclick="decodeInput()">Decode</button>
        <button class="btn secondary" onclick="clearAll()">Clear</button>
      </div>
      <p class="muted" style="margin:.6rem 0 .2rem">Or scan with camera</p>
      <div id="qrScanner"></div>
      <div style="margin-top:8px">
        <button id="startBtn" class="btn" onclick="startScanner()">Start Camera</button>
        <button id="stopBtn" class="btn secondary" onclick="stopScanner()" disabled>Stop Camera</button>
      </div>
    </section>

    <section id="decodedCard" class="card" style="display:none">
      <h2>Decoded Information</h2>
      <div class="result">
        <div class="box"><b>Cell Type</b><span id="cellType"></span></div>
        <div class="box"><b>Capacity</b><span id="capacity"></span></div>
        <div class="box"><b>Voltage</b><span id="voltage"></span></div>
        <div class="box"><b>Production Base</b><span id="base"></span></div>
        <div class="box"><b>Production Date</b><span id="date"></span></div>
        <div class="box"><b>Serial</b><span id="serial"></span></div>
      </div>
      <p id="notes" class="muted" style="margin-top:10px"></p>
    </section>

    <section class="card">
      <h2>How it works</h2>
      <p class="muted">This tool decodes GREAT POWER cell QR codes. Enter a code or scan to see the production year, month, day, and serial.</p>
    </section>
  </main>

  <footer>Â© <span id="yearNow"></span> BEVE POWER</footer>

  <!-- QR Scanner library via CDN (kept external to keep the package light). 
       If you want a fully offline build, download this file and place it in /assets, then change the src below. -->
  <script>
    const LIB_URL = "https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js";

    // Mapping tables
    const yearMap = {'B':2021,'C':2022,'D':2023,'E':2024,'F':2025,'G':2026,'H':2027,'J':2028,'K':2029};
    const monthMap = {'1':'Jan','2':'Feb','3':'Mar','4':'Apr','5':'May','6':'Jun','7':'Jul','8':'Aug','9':'Sep','A':'Oct','B':'Nov','C':'Dec'};
    const dateMap = {'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'A':10,'B':11,'C':12,'D':13,'E':14,'F':15,'G':16,'H':17,'J':18,'K':19,'L':20,'M':21,'N':22,'P':23,'R':24,'S':25,'T':26,'V':27,'W':28,'X':29,'Y':30,'O':31};

    function decodeCell(qr){
      qr = (qr||'').trim().toUpperCase();
      if(!qr) return {error:'Empty QR payload'};
      const serialMatch = qr.match(/\d{5,}$/);
      const serial = serialMatch ? serialMatch[0] : 'Unknown';
      const before = serialMatch ? qr.slice(0,-serial.length) : qr;
      const dateC = before.slice(-1);
      const monthC = before.slice(-2,-1);
      const yearC = before.slice(-3,-2);
      const year = yearMap[yearC] || 'Unknown';
      const month = monthMap[monthC] || 'Unknown';
      const day = dateMap[dateC] || 'Unknown';
      const capacity = qr.includes('100')?'100Ah': qr.includes('300')?'300Ah': (qr.includes('280')?'280Ah':'Unknown');
      return {year,month,day,serial,capacity};
    }

    function decodeInput(){
      const qr = document.getElementById('qrInput').value;
      const r = decodeCell(qr);
      if(r.error){ alert(r.error); return; }
      document.getElementById('decodedCard').style.display='block';
      document.getElementById('cellType').textContent='GREAT POWER';
      document.getElementById('capacity').textContent=r.capacity;
      document.getElementById('voltage').textContent='3.2V';
      document.getElementById('base').textContent='BEVE Factory';
      document.getElementById('date').textContent=`${r.day} ${r.month} ${r.year}`;
      document.getElementById('serial').textContent=r.serial;
      document.getElementById('notes').textContent='Decoded successfully.';
    }

    function clearAll(){
      document.getElementById('qrInput').value='';
      document.getElementById('decodedCard').style.display='none';
      stopScanner();
    }

    // QR scanner
    let scanner=null, running=false;
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=src; s.onload=resolve; s.onerror=()=>reject(new Error('Failed to load '+src));
        document.head.appendChild(s);
      });
    }
    async function startScanner(){
      document.getElementById('startBtn').disabled=true;
      try{
        if(typeof Html5Qrcode==='undefined'){ await loadScript(LIB_URL); }
        scanner = new Html5Qrcode('qrScanner');
        const cfg = { fps:10, qrbox:{ width: Math.min(280, Math.floor(window.innerWidth*0.8)), height: Math.min(280, Math.floor(window.innerWidth*0.8)) } };
        await scanner.start({ facingMode:'environment' }, cfg,
          (text)=>{ stopScanner(); document.getElementById('qrInput').value=text; decodeInput(); },
          ()=>{} // ignore frame errors
        );
        running=true;
        document.getElementById('stopBtn').disabled=false;
      }catch(err){
        alert('Camera error: '+err.message);
        document.getElementById('startBtn').disabled=false;
      }
    }
    function stopScanner(){
      if(scanner && running){
        scanner.stop().then(()=>scanner.clear()).catch(()=>{});
      }
      running=false;
      document.getElementById('stopBtn').disabled=true;
      document.getElementById('startBtn').disabled=false;
    }

    // Footer year
    document.getElementById('yearNow').textContent = new Date().getFullYear();

    // Prefill an example for quick testing (optional)
    window.addEventListener('load', ()=>{
      const input = document.getElementById('qrInput');
      if(!input.value) input.value = '02KCBFD16100BGF2R2001758';
    });
  </script>
</body>
</html>
