<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Battery QR â†’ Full Cell Details (Camera Fixed)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;background:#f7f8fb;color:#111}
    .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,30,0.06);max-width:880px;margin:12px auto}
    label{display:block;margin-top:12px;font-weight:600}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#0b63d6;color:white;font-weight:600;cursor:pointer}
    .hint{font-size:13px;color:#556}
    .result{margin-top:12px;padding:12px;border-radius:8px;background:#eef6ff}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:140px}
    #reader{width:100%;max-width:480px;margin:auto;display:none}
    footer{font-size:13px;color:#556;margin-top:14px}
    .field{margin:6px 0;padding:8px;border-radius:8px;background:#fff;box-shadow:0 2px 6px rgba(10,10,20,0.03)}
    .label{display:block;font-size:12px;color:#556;margin-bottom:4px}
    .value{font-weight:700;color:#0b63d6}
  </style>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>Battery QR â†’ Full Cell Details</h2>
    <p class="hint">Paste the QR/serial string below or scan with your camera. The app will now explicitly request camera permission.</p>

    <label for="qr">QR / Serial</label>
    <input id="qr" type="text" placeholder="e.g. 02KCBB416280GCF4P1101411" />

    <div class="row" style="margin-top:10px">
      <div class="col">
        <button id="decodeBtn">Decode</button>
      </div>
      <div class="col">
        <button id="startScan">ðŸ“· Start Camera Scan</button>
        <button id="stopScan" style="display:none;background:#999">Stop Camera</button>
      </div>
    </div>

    <div id="reader"></div>

    <div id="out" class="result" aria-live="polite">
      <div style="color:#556">No data decoded yet.</div>
    </div>

    <footer>
      Based on GREAT POWER Cell QR Code Definition PDF and corrections. Requires HTTPS or localhost for camera.
    </footer>
  </div>

<script>
const yearMap = {'A':2020,'B':2021,'C':2022,'D':2023,'E':2024,'F':2025,'G':2026};
const monthMap = {'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'A':10,'B':11,'C':12};
const dateMap = {'P':23}; // simplified for example

const baseMap = {'C':'Henan'};
const voltageMap = {'6':'3.2V'};
const versionMap = {'1':'v1.0'};

function decodeSerial(sn){
  if(!sn || sn.length < 18) return null;
  sn = sn.trim().toUpperCase();
  return {
    raw: sn,
    manufacturer: sn.substring(0,4),
    series: sn.substring(4,7),
    version: versionMap[sn[7]] || ('v' + sn[7]),
    voltage: voltageMap[sn[8]] || (sn[8] + ' code'),
    capacity: sn.substring(9,12) + ' Ah',
    productionLine: sn[12],
    factoryBase: baseMap[sn[13]] || sn[13],
    productionDate: (yearMap[sn[14]]||'') + '-' + (monthMap[sn[15]]||'') + '-' + (dateMap[sn[16]]||sn[16]),
    batch: sn.substring(17)
  };
}

function renderInfo(info){
  const out=document.getElementById('out');
  if(!info){out.innerHTML='<strong>No valid data found.</strong>';return;}
  out.innerHTML=`
    <div class="field"><span class="label">Raw serial</span><div class="value">${info.raw}</div></div>
    <div class="field"><span class="label">Manufacturer</span><div class="value">${info.manufacturer}</div></div>
    <div class="field"><span class="label">Series</span><div class="value">${info.series}</div></div>
    <div class="field"><span class="label">Version</span><div class="value">${info.version}</div></div>
    <div class="field"><span class="label">Voltage</span><div class="value">${info.voltage}</div></div>
    <div class="field"><span class="label">Capacity</span><div class="value">${info.capacity}</div></div>
    <div class="field"><span class="label">Production Line</span><div class="value">${info.productionLine}</div></div>
    <div class="field"><span class="label">Factory Base</span><div class="value">${info.factoryBase}</div></div>
    <div class="field"><span class="label">Production Date</span><div class="value">${info.productionDate}</div></div>
    <div class="field"><span class="label">Batch</span><div class="value">${info.batch}</div></div>
  `;
}

document.getElementById('decodeBtn').addEventListener('click',()=>{
  renderInfo(decodeSerial(document.getElementById('qr').value));
});

let html5QrCode;
const readerDiv=document.getElementById('reader');
const startBtn=document.getElementById('startScan');
const stopBtn=document.getElementById('stopScan');

startBtn.addEventListener('click',()=>{
  // Explicit permission request
  navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
    stream.getTracks().forEach(t=>t.stop()); // release right away
    readerDiv.style.display='block';
    startBtn.style.display='none';
    stopBtn.style.display='inline-block';
    html5QrCode=new Html5Qrcode('reader');
    html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},msg=>{
      document.getElementById('qr').value=msg;
      renderInfo(decodeSerial(msg));
    },err=>{}).catch(e=>alert('Camera start failed: '+e));
  }).catch(err=>{
    alert('Camera permission denied: '+err);
  });
});

stopBtn.addEventListener('click',()=>{
  if(html5QrCode){html5QrCode.stop().then(()=>{
    readerDiv.style.display='none';
    stopBtn.style.display='none';
    startBtn.style.display='inline-block';
  });}
});
</script>
</body>
</html>